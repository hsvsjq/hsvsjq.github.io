<html>
    <head>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.1.3/dist/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    </head>

    <body>
        <div class="row justify-content-center mt-5">
            <div class="col-10">
                <div class="row">
                    <button onclick="pageLeft()"><</button>
                    <select onchange="rowQtyChanged()" name="row_qty" id="row_qty">
                        <option value="10">10</option>
                        <option value="20">20</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                    </select>
                    <button onclick="pageRight()">></button>
                </div>
                <div class="row">
                    <table class="table col-10 table-bordered table-responsive">
                        <thead>
                            <tr id="table_header_row"></tr>
                        </thead>
                        <tbody id="table_body"></tbody>
                    </table>
                </div>
            </div>
        </div>
        <script src="database.js"></script>
        <script type="module">
            import {createClient} from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm'
            const supabase = createClient('https://sjylbgbijbteoivtkgks.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNqeWxiZ2JpamJ0ZW9pdnRrZ2tzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MTIzOTk2MzUsImV4cCI6MjAyNzk3NTYzNX0.b5F9xg28Sce_qyyKBXxgrFeioFq0Whqm8Yd_hVz31X4')

            const tableHeader = document.getElementById('table_header_row') 
            const tableBody = document.getElementById('table_body') 
            const rowQty = document.getElementById('row_qty') 

            const urlParams = new URLSearchParams(window.location.search);
            const paramChartDiffId = urlParams.get("chartDiffId")
            const paramChartId = urlParams.get("chartId")
            //const paramUserId = urlParams.get("userId") TODO
            
            const paramRowQty = urlParams.get("RowQty")
            if(paramRowQty) rowQty.value = paramRowQty
            const rowCount = parseInt(rowQty.value)

            const paramPage = urlParams.get("page")
            var page = 1
            if (paramPage){
                var temp = parseInt(paramPage)
                if(temp >= 2)
                    page = temp
            }

            const lowerBound = (page - 1) * rowCount
            const upperBound = (page) * rowCount - 1
            
            if(paramChartDiffId){
                supabase.from('score').select('*').eq('chartDiffId', paramChartDiffId).range(lowerBound, upperBound).then((result) => {
                    tabulateData(result.data, 'score')
                })
            }else if (paramChartId){
                supabase.from('chartDiff').select('*').eq('chartId', paramChartId).range(lowerBound, upperBound).then((result) => {
                    tabulateData(result.data, 'chartDiff')
                })
            }else{
                supabase.from('chart').select('*').range(lowerBound, upperBound).then((result) => {
                    tabulateData(result.data, 'chart')
                })
            }

            
            
            
            function tabulateData(data, type){
                clearTable()
                if (data.length <= 0) return

                var idHref = null
                var userHref = null

                if(type == 'chart'){
                    idHref = '&chartId='
                }else if (type == 'chartDiff'){
                    idHref = '&chartDiffId='
                }else if(type == 'score'){
                    //userHref = 'user'     TODO
                }

                

                Object.keys(data[0]).forEach(element => {
                    const child = document.createElement('th')
                    child.innerHTML = element 
                    tableHeader.appendChild(child)
                });
                data.forEach(element => {
                    const row = document.createElement('tr')
                    Object.entries(element).forEach(entry => {
                        const child = document.createElement('td')
                        const c = document.createElement('a')
                        c.innerHTML = entry[1]
                        if(entry[0] == 'id'){
                            if(idHref)
                                c.setAttribute('href', location.protocol + "//" + location.host + location.pathname + '?RowQty=' + rowCount + idHref + entry[1])
                        }
                        child.appendChild(c)
                        row.appendChild(child)
                    })

                    tableBody.appendChild(row)
                });
            }

            function clearTable(){
                removeAllChildNodes(tableHeader)
                removeAllChildNodes(tableBody)
            }

            function removeAllChildNodes(parent) {
                while (parent.firstChild) 
                    parent.removeChild(parent.firstChild);
            }            
        </script>
    </body>
</html>